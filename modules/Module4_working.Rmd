---
title: "Module 4 Blanks"
output: html_document
date: "2025-08-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Module 4: Statistical analysis in R

#### Sources
Content for this Module is derived from:
* https://www.emilyzabor.com/survival-analysis-in-r.html
* https://www.tidymodels.org/learn/models/parsnip-ranger-glmnet/
ChatGPT was used in the creation of examples and explanations.

### Objectives
By the end of this session, learners will be able to:
	* Perform basic statistical tests in R
	* Test for model assumptions
	* Perform survival analysis
	
### Introduction

R is primarily a statistical programming language. The focus of this module is not to learn statistics deeply. This content could be a whole semester's course. The survival analysis alone could be a multi-day workshop. But it's a quick run through many of the types of statistical tests you can run in R. 

```{r}

#library(tidyverse) if you have installed the whole tidyverse you can load it
library(dplyr)
library(tidyr)
library(survival)
library(survminer)
library(ggsurvfit)
library(gtsummary)
```

We will use the lung dataset from the `survival` package as example data. The data contain subjects with advanced lung cancer from the North Central Cancer Treatment Group.

The variables are described [here](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/lung.html)

What do the sex, time, status, and ph.ecog variables mean?


```{r}

# Save the dataset to a variable called "df"
df<-survival::lung

# Check out the dataset and variables

```

### T-test: Do women or men survive longer?

You can use a t-test when:

1) the outcome variable is continuous (e.g., height, blood pressure)
2) You have two groups to compare the means of, such as:
  * Treatment vs control
  * Males vs females
  * Before vs after intervention
3) Observations are independent (except for paired t-test)
4) The data are (approximately) normally distributed.
5) You assume equal or unequal variances depending on the type of t-test.

Here we are performing a two-sample t-test comparing the means between 2 groups.
```{r}

# The variable sex is numeric, let's convert to a factor

# Perform t-test

# Let's look at the data with a boxplot


# Let's check the assumptions by looking at the variance in each group


# Let's check normality with the Shapiro-Wilk test of normality

#Note that 2 is female and 1 is male

# Both are significant, which means the distributions are unlikely to be normal.
# It's probably best to try a non-parametric test like the Mann Whitney U (Wilcoxon Rank Sum Test)



```

### Chi-squared test and Fisher exact test: Is ECOG associated with death?

We will perform a Chi-square test of indepdence to test of the association between two categorical variables. You can think of this as a 2 x 2 table or Y x X table with counts in each cell.

ECOG Performance Status Scale describes a patient's level of functioning in terms of their ability to care for themself, daily activity, and physical 

Assumptions:
1. Both variables are categorical
2. Observations are independent
3. Expected cell counts should generally be ≥ 5 (for valid p-values)
4. Data are counts (not proportions or percentages)

A significant p-value (typically < 0.05) suggests there is an association between the variables (they’re not independent).

If the assumption's are violated you can use the Fisher's Exact Test.

```{r}

# in base R we can use the function table()

# Here we see there was a sample with NA for ECOG status. We didn't see this with table() because we have to force it to include NA


# Let's drop the sample with the NA value



# Because the assumptions are not met (some cells are 0) we should try a Fisher's exact test


```

### ANOVA (Analysis of Variance): Is survival time different between ECOG statuses?

Use Case:
1) The dependent variable is continuous (e.g., blood pressure, cholesterol)
2) The independent variable is categorical with three or more groups (e.g., diet group A/B/C, education levels).
3) You want to test whether group means are equal.

Assumptions:
1) Independence of observations
2) Normality of the dependent variable within each group
3) Equal variances across groups (homogeneity of variance)

ANOVA tells you there is a difference, but not where the difference is — that’s what post-hoc tests are for (e.g., Tukey’s HSD).

```{r}

# The variable ph.ecog is numeric, let's convert to a factor


# ANOVA


# Post-hoc test


# Plot


```


### Linear regression: 

Linear regression is modeling a continuous outcome using one or more predictors.

```{r}

# First let's look for the association between ECOG and survival time with lm()




# Diagnostic plots

# plots

```

### Logistic regression: Is the number of calories in a meal associated with sex?

If the outcome is binary, we use a generalized version of linear regression, called logistic regression with glm() function

```{r}

#logistic regression with glm()

#diagnostic plots

```


### Survival analysis

This dataset is actually more appropriately analyzed with survival methods because we have survival time in days and death/censored status.Ignoring censoring like we have done thus far will lead to incorrect estimates of probability of survival, ultimately oversesitmating the overall survival probability.

`survival` and `survminer` are popular packages for this type of analysis. `ggsurvfit` allows for nice data visualization and includes some of the same functionality.

The `Surv()` function from the `survival` package creates a survival object for use as the response in a model formula. There is one entry for each subject that is the survival time, which is followed by a + if the subject was censored.

```{r}

# Note that the status is coded in a non-standard way in this dataset. Typically you will see 1=event, 0=censored. Let’s recode it to avoid confusion:

# Create survival object


#check the first 10 observations

```

### Kaplain Meier Curve

Let’s generate the overall Kaplan Meier curve for the entire cohort.

The `survfit()` function creates survival curves using the Kaplan-Meier method based on a formula.

The key components of this survfit object include:

time: the timepoints at which the curve has a step, i.e. at least one event occurred
surv: the estimate of survival at the corresponding time

```{r}

# first let's use survfit() to make a survfit object


# survminer has a plotting function ggsurvplot() which uses ggplot


# We can also use the ggsurvfit package for plotting

#Functions from ggsurvfit work best if we use built in functions to make the survfit object; note how we can pipe this object into ggsurvfit()



# we also added a confidence interval and a risk table using grammar of graphics layering

# the gtsummary package can make a publication-ready table estimating probability of 1-year survival

```

# The Cox regression model: Is sex associated with hazard of death?

We can use the Cox regresion model when we want to estimate an effect size for a single variable, or include multiple variables into a regression model to account for their effects.

The Cox regression model is a semi-parametric model that can be used to fit univariable and multivariable regression models that have survival outcomes. It assumes 1) proportional hazards and 2) non-informative censoring.

We fit regression models for survival data using the `coxph()` function from the `survival` package. This takes a `Surv()` object on the left hand side and a regression formula on the right hand side.

We can obtain tables of results using the `tbl_regression()` function from the `gtsummary` package. We can plot the hazard ratios using `ggforest()` from the `survminer` package.

The quantity of interest from a Cox regression model is a hazard ratio (HR). The HR represents the ratio of hazards between two groups at any particular point in time. It is the exponentiated beta estimate from the regression. A HR < 1 indicates reduced hazard of death whereas a HR > 1 indicates an increased hazard of death.

```{r}
# Plot

# Fit Cox model with sex as variable of interest




# Plot hazard ratios with ggforest() from the survminer package


# we can visualize the survival curves between male and female


# How could we relabel the sex variables in the plot as Male/Female?
# How could we test the association between the ECOG value and survival?

```



